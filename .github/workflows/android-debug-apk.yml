name: Android Release APK

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install deps
        run: |
          npm ci

      - name: Prebuild Android (idempotent)
        run: |
          npx expo prebuild --platform android --non-interactive

      - name: Enable universal APK (in addition to splits)
        run: |
          if [ -f android/app/build.gradle ]; then
            sed -i 's/universalApk false/universalApk true/g' android/app/build.gradle || true
            # If no universalApk line existed, ensure a universal is generated by appending inside splits block
            if ! grep -q "universalApk true" android/app/build.gradle; then
              echo "Patching build.gradle to add universalApk true";
              awk '1;/splits[[:space:]]*{[[:space:]]*abi[[:space:]]*{/{print "            universalApk true"}' android/app/build.gradle > android/app/build.gradle.tmp || cp android/app/build.gradle android/app/build.gradle.tmp
              mv android/app/build.gradle.tmp android/app/build.gradle
            fi
          fi

      - name: Build release APK
        working-directory: android
        run: |
          ./gradlew assembleRelease --no-daemon --stacktrace

      - name: Upload APK artifact(s)
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apks
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 14

      - name: Upload ProGuard mapping
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mapping.txt
          path: android/app/build/outputs/mapping/release/mapping.txt
          retention-days: 30
